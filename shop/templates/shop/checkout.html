{% extends "base.html" %}
{% block title %}Checkout - Cupcake Shop{% endblock %}

{% block content %}
<div class="container">
    <h1 class="text-center my-4">Checkout</h1>
    <h2 class="mb-4">Review Your Order</h2>

    <!-- Payment Status Messages -->
    <div id="payment-messages" class="alert alert-danger" style="display:none;"></div>

    {% if cart_items %}
    <!-- ... (your existing cart table code remains the same) ... -->

    <h2 class="mt-5 mb-4">Delivery & Payment Details</h2>
    <form id="payment-form">
        {% csrf_token %}
        
        <!-- ... (your existing delivery address fields remain the same) ... -->

        <!-- Payment Buttons -->
        <div class="text-center mt-4">
            <button type="button" class="btn btn-info btn-lg me-3" disabled>
                <i class="fa-solid fa-wallet"></i> Pay with Wallet (Coming Soon)
            </button>
            <button type="button" id="card-payment-btn" class="btn btn-primary btn-lg">
                <i class="fa-solid fa-credit-card"></i> Pay with Card
            </button>
        </div>
    </form>
    {% else %}
    <div class="alert alert-info text-center">
        <p>Your cart is empty. <a href="{% url 'shop' %}" class="text-primary">Continue shopping</a>.</p>
    </div>
    {% endif %}
</div>

<!-- Stripe Elements Container -->
<div id="card-element" class="form-control mb-3" style="display:none;"></div>
<div id="card-errors" role="alert" class="text-danger mb-3"></div>

<!-- Pay Now Button (initially hidden) -->
<button id="submit-payment" class="btn btn-success btn-lg" style="display:none;">
    <i class="fa-solid fa-lock"></i> Pay Now
</button>

<!-- Stripe Script -->
<script src="https://js.stripe.com/v3/"></script>
<script>
    // Initialize Stripe
    var stripe = Stripe('{{ STRIPE_PUBLIC_KEY }}');
    var elements = stripe.elements();
    var cardElement;

    // Show card form when Pay with Card is clicked
    document.getElementById('card-payment-btn').addEventListener('click', function() {
        document.getElementById('card-payment-btn').style.display = 'none';
        document.getElementById('card-element').style.display = 'block';
        document.getElementById('submit-payment').style.display = 'block';
        
        // Create card element if not already created
        if (!cardElement) {
            var style = {
                base: {
                    color: '#32325d',
                    fontFamily: '"Helvetica Neue", Helvetica, sans-serif',
                    fontSize: '16px',
                    '::placeholder': {
                        color: '#aab7c4'
                    }
                },
                invalid: {
                    color: '#fa755a',
                    iconColor: '#fa755a'
                }
            };
            
            cardElement = elements.create('card', {style: style});
            cardElement.mount('#card-element');
            
            // Handle real-time validation errors
            cardElement.on('change', function(event) {
                var displayError = document.getElementById('card-errors');
                if (event.error) {
                    displayError.textContent = event.error.message;
                } else {
                    displayError.textContent = '';
                }
            });
        }
    });

    // Handle form submission
    document.getElementById('submit-payment').addEventListener('click', async function(e) {
        e.preventDefault();
        
        var submitButton = this;
        submitButton.disabled = true;
        submitButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Processing...';
        
        var paymentMessage = document.getElementById('payment-messages');
        
        try {
            // Create payment method
            const {error, paymentMethod} = await stripe.createPaymentMethod({
                type: 'card',
                card: cardElement,
            });

            if (error) {
                throw error;
            }

            // Send to your backend
            const response = await fetch('{% url "process_payment" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}',
                },
                body: JSON.stringify({
                    payment_method_id: paymentMethod.id,
                    amount: Math.round({{ cart_total|floatformat:2 }} * 100), // Convert to cents
                    delivery_address: document.getElementById('delivery_address').value,
                    city: document.getElementById('city').value,
                    postal_code: document.getElementById('postal_code').value,
                    country: document.getElementById('country').value,
                    store_pickup: document.getElementById('store_pickup').checked
                }),
            });

            const result = await response.json();
            
            if (result.success) {
                paymentMessage.style.display = 'block';
                paymentMessage.className = 'alert alert-success';
                paymentMessage.innerHTML = `
                    <h4><i class="fas fa-check-circle"></i> Payment Successful!</h4>
                    <p>Your order #${result.order_id} has been placed.</p>
                    <p>You will receive a confirmation email shortly.</p>
                    <a href="{% url 'order_success' %}?order_id=${result.order_id}" class="btn btn-success">
                        View Order Details
                    </a>
                `;
                // Optionally clear the cart here
            } else {
                throw new Error(result.error || 'Payment failed');
            }
        } catch (error) {
            paymentMessage.style.display = 'block';
            paymentMessage.className = 'alert alert-danger';
            paymentMessage.innerHTML = `
                <h4><i class="fas fa-exclamation-circle"></i> Payment Failed</h4>
                <p>${error.message}</p>
                <button class="btn btn-primary" onclick="window.location.reload()">
                    Try Again
                </button>
            `;
        } finally {
            submitButton.disabled = false;
            submitButton.innerHTML = '<i class="fa-solid fa-lock"></i> Pay Now';
        }
    });
</script>
{% endblock %}