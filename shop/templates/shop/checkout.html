{% extends 'shop/base.html' %}
{% load static %}

{% block content %}
<div class="container mt-5">
  <h2>Checkout</h2>
  <hr>
  {% if cart_items %}
    <ul class="list-group mb-3">
      {% for item in cart_items %}
        <li class="list-group-item d-flex justify-content-between lh-sm">
          <div>
            <h6 class="my-0">{{ item.cupcake.name }}</h6>
            <small class="text-muted">Qty: {{ item.quantity }}</small>
          </div>
          <span class="text-muted">${{ item.cupcake.price|floatformat:2 }}</span>
        </li>
      {% endfor %}
      <li class="list-group-item d-flex justify-content-between">
        <strong>Total (USD)</strong>
        <strong>${{ total_price|floatformat:2 }}</strong>
      </li>
    </ul>

    <!-- Payment Form -->
    <form id="payment-form">
      <div class="mb-3">
        <label for="card-element">Credit or debit card</label>
        <div id="card-element" class="form-control"></div>
        <div id="card-errors" role="alert" class="text-danger mt-2"></div>
      </div>

      <!-- Delivery Info -->
      <h5 class="mt-4">Delivery Information</h5>
      <input class="form-control mt-2" id="address" placeholder="Address" required>
      <input class="form-control mt-2" id="city" placeholder="City" required>
      <input class="form-control mt-2" id="postal_code" placeholder="Postal Code" required>
      <input class="form-control mt-2" id="country" placeholder="Country" required>
      <div class="form-check mt-3">
        <input class="form-check-input" type="checkbox" id="store_pickup">
        <label class="form-check-label" for="store_pickup">
          Pickup from store
        </label>
      </div>

      <button id="submit" class="btn btn-primary mt-4">Pay ${{ total_price|floatformat:2 }}</button>
    </form>
  {% else %}
    <p>Your cart is empty.</p>
  {% endif %}
</div>

<script src="https://js.stripe.com/v3/"></script>
<script>
  const stripe = Stripe("{{ stripe_public_key }}");
  const elements = stripe.elements();
  const card = elements.create('card');
  card.mount('#card-element');

  const form = document.getElementById('payment-form');
  form.addEventListener('submit', async function(e) {
    e.preventDefault();
    const { paymentMethod, error } = await stripe.createPaymentMethod('card', card);

    if (error) {
      document.getElementById('card-errors').textContent = error.message;
    } else {
      fetch("{% url 'create_payment_intent' %}", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": "{{ csrf_token }}"
        },
        body: JSON.stringify({
          payment_method_id: paymentMethod.id,
          amount: {{ total_price|floatformat:2|floatformat:0|stringformat:"d" }}00,
          delivery_info: {
            address: document.getElementById('address').value,
            city: document.getElementById('city').value,
            postal_code: document.getElementById('postal_code').value,
            country: document.getElementById('country').value,
            store_pickup: document.getElementById('store_pickup').checked
          }
        })
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          window.location.href = `{% url 'order_success' %}?order_id=${data.order_id}`;
        } else {
          document.getElementById('card-errors').textContent = data.error || 'Payment failed.';
        }
      });
    }
  });
</script>
{% endblock %}
